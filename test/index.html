<html>
<body>
    <div>
        <button onclick="debugImageModel()">å¼€å§‹è°ƒè¯• - æ¢æŸ¥æ¨¡å‹è¿”å›æ ¼å¼</button>
    </div>
    <div id="debugOutput" style="margin-top:20px; padding:15px; border:1px solid #ccc; background:#f9f9f9; white-space: pre-wrap; font-family: monospace;"></div>
    <div id="imagePreview" style="margin-top:20px;"></div>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        async function debugImageModel() {
            const debugDiv = document.getElementById('debugOutput');
            const previewDiv = document.getElementById('imagePreview');
            debugDiv.innerHTML = 'ğŸ•µï¸ æ­£åœ¨å‘é€è¯·æ±‚å¹¶æ¢æŸ¥è¿”å›æ ¼å¼...\n\n';
            previewDiv.innerHTML = '';

            try {
                // 1. å°è¯•ä½¿ç”¨ images.generate (å¦‚æœå­˜åœ¨)
                debugDiv.innerHTML += '=== å°è¯•æ–¹æ³•: puter.ai.images.generate ===\n';
                if (typeof puter.ai.images !== 'undefined' && puter.ai.images.generate) {
                    const payload = {
                        prompt: "A simple red apple on a table", // ä½¿ç”¨ç®€å•æç¤º
                        model: 'openrouter:bytedance-seed/seedream-4.5',
                        size: "512x512"
                    };
                    debugDiv.innerHTML += `å‘é€è½½è·: ${JSON.stringify(payload, null, 2)}\n---\n`;
                    
                    const result = await puter.ai.images.generate(payload);
                    debugDiv.innerHTML += `âœ… åŸå§‹å“åº”å¯¹è±¡:\n${JSON.stringify(result, null, 2)}\n\n`;
                    inspectResponse(result, debugDiv, previewDiv);
                } else {
                    debugDiv.innerHTML += 'âŒ puter.ai.images.generate ä¸å­˜åœ¨ï¼Œè·³è¿‡ã€‚\n\n';
                }

                // 2. å°è¯•ä½¿ç”¨ chat æ¥å£ï¼ˆå…³é”®æ­¥éª¤ï¼‰
                debugDiv.innerHTML += '=== å°è¯•æ–¹æ³•: puter.ai.chat (éæµå¼) ===\n';
                const chatPayload = {
                    model: 'openrouter:bytedance-seed/seedream-4.5',
                    stream: false, // ä½¿ç”¨éæµå¼ä»¥ä¾¿è·å–å®Œæ•´å¯¹è±¡
                    messages: [
                        { role: 'user', content: 'Generate an image of a simple red apple.' }
                    ]
                };
                debugDiv.innerHTML += `å‘é€è½½è·: ${JSON.stringify(chatPayload, null, 2)}\n---\n`;
                
                const chatResponse = await puter.ai.chat(chatPayload);
                debugDiv.innerHTML += `âœ… åŸå§‹å“åº”å¯¹è±¡:\n${JSON.stringify(chatResponse, null, 2)}\n\n`;
                inspectResponse(chatResponse, debugDiv, previewDiv);

                // 3. å°è¯•æµå¼æ¥å£ï¼ˆå¦‚æœæ”¯æŒï¼‰
                debugDiv.innerHTML += '=== å°è¯•æ–¹æ³•: puter.ai.chat (æµå¼) ===\n';
                debugDiv.innerHTML += 'ï¼ˆæ­¤æ–¹æ³•ç”¨äºæ¢æŸ¥æ˜¯å¦åˆ†å—è¿”å›å›¾åƒæ•°æ®ï¼‰\n---\n';
                const streamResponse = await puter.ai.chat({
                    model: 'openrouter:bytedance-seed/seedream-4.5',
                    stream: true,
                    messages: [
                        { role: 'user', content: 'A simple red apple.' }
                    ]
                });
                
                let aggregatedText = '';
                for await (const chunk of streamResponse) {
                    debugDiv.innerHTML += `æ”¶åˆ°æµå—: ${JSON.stringify(chunk)}\n`;
                    aggregatedText += chunk?.text || '';
                }
                if (aggregatedText) {
                    debugDiv.innerHTML += `\nğŸ” èšåˆçš„æ–‡æœ¬å†…å®¹:\n${aggregatedText}\n`;
                    tryParseAsImage(aggregatedText, debugDiv, previewDiv);
                }

            } catch (error) {
                debugDiv.innerHTML += `âŒ è¯·æ±‚å¤±è´¥:\n${error.message}\n${error.stack}\n`;
                console.error('è°ƒè¯•é”™è¯¯:', error);
            }
        }

        // åˆ†æå“åº”å¯¹è±¡çš„é€šç”¨å‡½æ•°
        function inspectResponse(obj, debugDiv, previewDiv) {
            // é€’å½’æŸ¥æ‰¾æ‰€æœ‰å­—ç¬¦ä¸²å±æ€§ï¼Œçœ‹æ˜¯å¦æœ‰Base64å›¾åƒæˆ–URL
            function findPotentialImages(currentObj, path = '') {
                for (const key in currentObj) {
                    const value = currentObj[key];
                    const currentPath = path ? `${path}.${key}` : key;
                    
                    if (typeof value === 'string') {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯URL
                        if (value.startsWith('http://') || value.startsWith('https://')) {
                            debugDiv.innerHTML += `ğŸŒ å‘ç°URL (ä½äº ${currentPath}): ${value}\n`;
                            previewDiv.innerHTML += `<div><strong>ä»URLåŠ è½½:</strong><br><img src="${value}" style="max-width:300px; border:2px solid blue;" onerror="this.style.display='none'"/></div>`;
                        }
                        // æ£€æŸ¥æ˜¯å¦æ˜¯Base64å›¾åƒæ•°æ®
                        if (value.startsWith('data:image/')) {
                            debugDiv.innerHTML += `ğŸ–¼ï¸ å‘ç°Base64å›¾åƒæ•°æ® (ä½äº ${currentPath})ï¼Œé•¿åº¦: ${value.length}\n`;
                            previewDiv.innerHTML += `<div><strong>Base64å›¾åƒ:</strong><br><img src="${value}" style="max-width:300px; border:2px solid green;"/></div>`;
                        }
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸å¸¦å‰ç¼€çš„Base64ï¼ˆå°è¯•æ·»åŠ å‰ç¼€ï¼‰
                        if (value.length > 100 && /^[A-Za-z0-9+/]+=*$/.test(value)) {
                            debugDiv.innerHTML += `ğŸ”¢ å‘ç°çº¯Base64å­—ç¬¦ä¸² (ä½äº ${currentPath})ï¼Œé•¿åº¦: ${value.length}\n`;
                            const testDataUrl = `data:image/png;base64,${value}`;
                            previewDiv.innerHTML += `<div><strong>å°è¯•è§£ç Base64:</strong><br><img src="${testDataUrl}" style="max-width:300px; border:2px solid orange;" onerror="this.style.display='none'"/></div>`;
                        }
                    } else if (typeof value === 'object' && value !== null) {
                        findPotentialImages(value, currentPath);
                    }
                }
            }
            
            findPotentialImages(obj);
        }

        // å°è¯•å°†æ–‡æœ¬è§£æä¸ºå›¾åƒ
        function tryParseAsImage(text, debugDiv, previewDiv) {
            // å°è¯•æå–JSONï¼ˆå¦‚æœå“åº”æ˜¯JSONå­—ç¬¦ä¸²ï¼‰
            try {
                const parsed = JSON.parse(text);
                debugDiv.innerHTML += `ğŸ“¦ æ–‡æœ¬å¯è§£æä¸ºJSONï¼Œå¼€å§‹åˆ†æå†…éƒ¨ç»“æ„...\n`;
                inspectResponse(parsed, debugDiv, previewDiv);
            } catch (e) {
                // ä¸æ˜¯JSONï¼ŒæŒ‰åŸæ–‡æœ¬å¤„ç†
                debugDiv.innerHTML += `ğŸ“ å“åº”æ˜¯çº¯æ–‡æœ¬ï¼Œä¸æ˜¯JSONã€‚\n`;
            }
        }
    </script>
</body>
</html>
