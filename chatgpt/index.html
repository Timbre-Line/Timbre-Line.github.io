<!DOCTYPE html>
<html>
<head>
    <title>ChatGPT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="icon.png" type="image/png">
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fff;
            color: #000;
            padding-top: 64px;
            padding-bottom: 140px;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px 15px;
            background: #fff;
            display: flex;
            align-items: center;
            z-index: 1000;
        }
        .new-chat-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            margin-right: 15px;
            position: relative;
        }
        .new-chat-btn:hover {
            background: #e5e5e5;
        }
        .new-chat-btn:hover::after {
            content: 'Êñ∞ËÅäÂ§©';
            position: absolute;
            bottom: -38px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1001;
        }
        .custom-select {
            position: relative;
            width: 250px;
        }
        .select-selected {
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            background: #fff;
            font-size: 14px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .select-selected::after {
            content: "‚ñº";
            font-size: 10px;
            color: #666;
        }
        .select-items {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
        }
        .select-items.active {
            display: block;
        }
        .select-item {
            padding: 10px 12px;
            cursor: pointer;
        }
        .select-item:hover {
            background: #f5f5f5;
        }
        .select-item.selected {
            background: #e3f2fd;
            font-weight: 500;
        }
        .select-group {
            color: #666;
            font-size: 12px;
            padding: 8px 12px 4px;
            cursor: default;
            background: #f8f9fa;
        }
        .select-group:hover {
            background: #f8f9fa;
        }
        .header-enhance {
            display: flex;
            gap: 6px;
            margin-left: 12px;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            white-space: nowrap;
        }
        .header-enhance::-webkit-scrollbar {
            display: none;
        }
        .enhance-btn {
            border: 1px solid #d0d0d0;
            border-radius: 18px;
            background: #fff;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            height: 36px;
            flex-shrink: 0;
            display: none;
        }
        .enhance-btn.active {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #1565c0;
        }
        .chat-container {
            height: calc(100vh - 204px);
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 16px;
            padding: 16px;
            background: #f5f5f5;
            border-radius: 10px;
            max-width: 85%;
        }
        .message.user {
            align-self: flex-end;
            background: #e0e0e0;
        }
        .message.ai {
            align-self: flex-start;
        }
        .model-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
        }
        .message-content {
            font-size: 16px;
            line-height: 1.5;
        }
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #000;
            font-size: 28px;
            margin: auto;
        }
        .bottom-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: #fff;
            z-index: 1000;
        }
        .web-search-toggle {
            border: 1px solid #d0d0d0;
            border-radius: 18px;
            background: #fff;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            height: 36px;
            margin-bottom: 8px;
        }
        .web-search-toggle.active {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #1565c0;
        }
        .input-container {
            display: flex;
            align-items: flex-start;
            position: relative;
        }
        .input-box {
            flex: 1;
            min-height: 48px;
            max-height: 132px;
            padding: 10px 50px 10px 15px;
            border: 1px solid #d0d0d0;
            border-radius: 24px;
            resize: none;
            font-size: 16px;
            font-family: inherit;
            background: #fff;
            color: #000;
            line-height: 1.4;
        }
        .input-box:focus { outline: none; border-color: #888; }
        .send-button {
            position: absolute;
            right: 10px;
            bottom: 8px;
            border: none;
            border-radius: 50%;
            background: #000;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .send-button:disabled { background: #ccc; cursor: not-allowed; }
        .send-button svg { fill: white; width: 18px; height: 18px; }
        .footer {
            text-align: center;
            padding: 12px 15px 0;
            font-size: 12px;
            color: #666;
        }
        .typing {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #888;
            border-radius: 50%;
            margin-right: 4px;
            animation: blink 1s infinite;
        }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
    </style>
</head>
<body>
    <div class="header">
        <button class="new-chat-btn" id="newChatBtn">
            <img src="icon.png" width="20" height="20">
        </button>
        <div class="custom-select" id="customSelect">
            <div class="select-selected" id="selectSelected">GPT-5.2 Instant</div>
            <div class="select-items" id="selectItems"></div>
        </div>
        <!-- Â¢ûÂº∫ÊåâÈíÆÁßªÂà∞Â§¥ÈÉ®Âè≥‰æß -->
        <div class="header-enhance" id="headerEnhance"></div>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="welcome-message" id="welcomeMessage"></div>
    </div>
    
    <div class="bottom-section">
        <button class="web-search-toggle" id="webSearchToggle">üåê ËÅîÁΩëÊêúÁ¥¢</button>
        <!-- Â∫ïÈÉ®ÂéüÊù•ÁöÑÂ¢ûÂº∫ÊåâÈíÆÂÆπÂô®Â∑≤ÁßªÈô§ÔºåÁé∞Âú®ÂÖ®ÈÉ®Áî±JSÂä®ÊÄÅÁÆ°ÁêÜ -->
        <div class="input-container">
            <textarea class="input-box" id="inputBox" placeholder="ÊúâÈóÆÈ¢òÔºåÂ∞ΩÁÆ°ÈóÆ" rows="2"></textarea>
            <button class="send-button" id="sendButton">
                <svg viewBox="0 0 24 24"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.58L20 12l-8-8-8 8z"></path></svg>
            </button>
        </div>
        <div class="footer">ÂèëÈÄÅÂç≥ÂêåÊÑèÊù°Ê¨æÂíåÈöêÁßÅÊîøÁ≠ñ</div>
    </div>

    <script>
        (function() {
            // ----- Á°¨ÁºñÁ†ÅÊ®°ÂûãÊò†Â∞Ñ -----
            const MODEL_NAMES = {
                'gpt-5.2-chat': 'GPT-5.2 Instant',
                'gpt-5.2': 'GPT-5.2 Thinking',
                'openrouter:openai/gpt-5.2-pro': 'GPT-5.2 Pro',
                'o1': 'OpenAI o1',
                'o3': 'OpenAI o3',
                'o3-mini': 'OpenAI o3-mini',
                'o4-mini': 'OpenAI o4-mini',
                'openrouter:openai/o3-deep-research': 'o3 Deep Research',
                'openrouter:openai/o3-pro': 'o3 Pro',
                'openrouter:openai/o3-mini-high': 'o3-mini High',
                'openrouter:openai/o4-mini-high': 'o4-mini High',
                'openrouter:openai/o4-mini-deep-research': 'o4-mini Deep Research',
                'openrouter:openai/gpt-4': 'GPT-4',
                'openrouter:openai/gpt-4-turbo': 'GPT-4 Turbo',
                'openrouter:openai/gpt-3.5-turbo': 'GPT-3.5 Turbo'
            };

            // Âü∫Á°ÄÊ®°ÂûãÂàÜÁªÑ (Âè™ÂåÖÂê´Âü∫Á°ÄID)
            const GROUPS = {
                'GPT-5.2 Á≥ªÂàó': ['gpt-5.2-chat', 'gpt-5.2', 'openrouter:openai/gpt-5.2-pro'],
                'o Á≥ªÂàó': ['o1', 'o3', 'o3-mini', 'o4-mini'],
                'Legacy (‰∏çËÉΩËÅîÁΩë)': ['openrouter:openai/gpt-4', 'openrouter:openai/gpt-4-turbo', 'openrouter:openai/gpt-3.5-turbo']
            };

            // È¢ÑÂÆö‰πâÁöÑÂ¢ûÂº∫ÊåâÈíÆÈÖçÁΩÆ (Áõ¥Êé•Á°¨ÁºñÁ†Å)
            const ENHANCEMENTS = [
                { base: 'o3', enhId: 'openrouter:openai/o3-deep-research', label: 'Deep Research' },
                { base: 'o3', enhId: 'openrouter:openai/o3-pro', label: 'Pro' },
                { base: 'o3-mini', enhId: 'openrouter:openai/o3-mini-high', label: 'High' },
                { base: 'o4-mini', enhId: 'openrouter:openai/o4-mini-high', label: 'High' },
                { base: 'o4-mini', enhId: 'openrouter:openai/o4-mini-deep-research', label: 'Deep Research' }
            ];

            // Ëé∑ÂèñÂÖÉÁ¥†
            const chatContainer = document.getElementById('chatContainer');
            const inputBox = document.getElementById('inputBox');
            const sendBtn = document.getElementById('sendButton');
            const webToggle = document.getElementById('webSearchToggle');
            const welcome = document.getElementById('welcomeMessage');
            const newChat = document.getElementById('newChatBtn');
            const selectSelected = document.getElementById('selectSelected');
            const selectItems = document.getElementById('selectItems');
            const customSelect = document.getElementById('customSelect');
            const headerEnhance = document.getElementById('headerEnhance');

            // Áä∂ÊÄÅ
            let isThinking = false;
            let webEnabled = false;
            let context = '';
            let hasSent = false;
            let activeEnhancement = null; // ÂΩìÂâçÊøÄÊ¥ªÁöÑÂ¢ûÂº∫Ê®°ÂûãID

            // Ê¨¢ËøéËØ≠
            welcome.textContent = ['Êúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÂøôÁöÑÔºü','Êàë‰ª¨ÂÖà‰ªéÂì™ÈáåÂºÄÂßãÂë¢Ôºü','ÂáÜÂ§áÂ•Ω‰∫Ü','‰ªäÂ§©Êúâ‰ªÄ‰πàËÆ°ÂàíÔºü','ÊÇ®‰ªäÂ§©Âú®ÊÉ≥‰ªÄ‰πàÔºü'][Math.floor(Math.random()*5)];

            // ÊûÑÂª∫‰∏ãÊãâÊ°Ü
            function buildSelect() {
                selectItems.innerHTML = '';
                for (let group in GROUPS) {
                    // ÂàÜÁªÑÊ†áÈ¢ò (Ê∑ªÂä† select-group Á±ªÔºå‰∏çÂèØÈÄâ)
                    let gDiv = document.createElement('div');
                    gDiv.className = 'select-item select-group';
                    gDiv.textContent = group;
                    selectItems.appendChild(gDiv);

                    GROUPS[group].forEach(id => {
                        let item = document.createElement('div');
                        item.className = 'select-item';
                        item.dataset.value = id;
                        item.textContent = MODEL_NAMES[id] || id;
                        if (group.includes('Legacy')) item.dataset.legacy = 'true';
                        selectItems.appendChild(item);
                    });
                }

                // ÈªòËÆ§ÈÄâ‰∏≠Á¨¨‰∏Ä‰∏™ (GPT-5.2 Instant)
                let first = document.querySelector('.select-item:not(.select-group)');
                if (first) {
                    first.classList.add('selected');
                    selectSelected.textContent = first.textContent;
                    let legacy = first.dataset.legacy === 'true';
                    webToggle.disabled = legacy;
                    webToggle.style.opacity = legacy ? '0.5' : '1';
                    updateEnhanceVisibility(first.dataset.value);
                }
            }

            // ÊûÑÂª∫Â§¥ÈÉ®Â¢ûÂº∫ÊåâÈíÆ
            function buildHeaderEnhance() {
                headerEnhance.innerHTML = '';
                ENHANCEMENTS.forEach(cfg => {
                    let btn = document.createElement('button');
                    btn.className = 'enhance-btn';
                    btn.dataset.base = cfg.base;
                    btn.dataset.enh = cfg.enhId;
                    btn.textContent = cfg.label;
                    headerEnhance.appendChild(btn);
                });
                // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂Ôºà‰∏é‰πãÂâçÁõ∏ÂêåÔºâ
                for (let btn of headerEnhance.children) {
                    btn.addEventListener('click', (e) => {
                        let base = document.querySelector('.select-item.selected')?.dataset.value;
                        if (btn.dataset.base !== base) return;

                        let enhId = btn.dataset.enh;
                        if (btn.classList.contains('active')) {
                            btn.classList.remove('active');
                            activeEnhancement = null;
                        } else {
                            for (let b of headerEnhance.children) {
                                if (b.dataset.base === base) b.classList.remove('active');
                            }
                            btn.classList.add('active');
                            activeEnhancement = enhId;
                        }
                    });
                }
            }

            // Ê†πÊçÆÂü∫Á°ÄÊ®°ÂûãÊòæÁ§∫/ÈöêËóèÂ¢ûÂº∫ÊåâÈíÆ
            function updateEnhanceVisibility(baseId) {
                activeEnhancement = null;
                for (let btn of headerEnhance.children) {
                    let show = (btn.dataset.base === baseId);
                    btn.style.display = show ? 'inline-block' : 'none';
                    btn.classList.remove('active');
                }
            }

            // Ëé∑ÂèñÊúÄÁªàÊ®°ÂûãID
            function getFinalModel() {
                let base = document.querySelector('.select-item.selected')?.dataset.value || 'gpt-5.2-chat';
                return activeEnhancement || base;
            }

            function getDisplayName(modelId) {
                return MODEL_NAMES[modelId] || modelId;
            }

            // Ê∑ªÂä†Ê∂àÊÅØ
            function addMessage(text, isUser = false, streaming = false, finalModel = null) {
                if (isUser && !hasSent) {
                    welcome.style.display = 'none';
                    hasSent = true;
                }
                let div = document.createElement('div');
                div.className = `message ${isUser ? 'user' : 'ai'}`;
                let content = document.createElement('div');
                content.className = 'message-content';
                if (isUser) {
                    content.innerHTML = text.replace(/\n/g, '<br>');
                } else if (streaming) {
                    content.innerHTML = '<span class="typing"></span>ÊÄùËÄÉ‰∏≠...';
                    div.id = 'streamingMessage';
                } else {
                    let label = document.createElement('span');
                    label.className = 'model-label';
                    label.textContent = `Generated by ${getDisplayName(finalModel)}`;
                    div.appendChild(label);
                    content.innerHTML = marked.parse(text);
                }
                div.appendChild(content);
                chatContainer.appendChild(div);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                return { div, content };
            }

            // ÂèëÈÄÅÊ∂àÊÅØ
            async function send() {
                if (isThinking) return;
                let text = inputBox.value.trim();
                if (!text) return;

                inputBox.value = '';
                addMessage(text, true);

                isThinking = true;
                sendBtn.disabled = true;
                inputBox.disabled = true;

                let { content } = addMessage('', false, true);
                let finalModel = getFinalModel();

                try {
                    let prompt = context + 'Áî®Êà∑: ' + text + '\nAI: ';
                    let opts = { stream: true, model: finalModel };
                    if (webEnabled && !webToggle.disabled) opts.tools = [{ type: 'web_search' }];

                    let res = await puter.ai.chat(prompt, opts);
                    let full = '';
                    content.innerHTML = '';

                    for await (let part of res) {
                        if (part?.text) {
                            full += part.text;
                            content.innerHTML = marked.parse(full);
                        }
                    }

                    context += 'Áî®Êà∑: ' + text + '\nAI: ' + full + '\n';
                    let lines = context.split('\n');
                    if (lines.length > 20) context = lines.slice(-20).join('\n');

                    let msgDiv = document.getElementById('streamingMessage');
                    if (msgDiv) msgDiv.id = '';
                    let container = content.parentNode;
                    let oldLabel = container.querySelector('.model-label');
                    if (oldLabel) oldLabel.remove();
                    let label = document.createElement('span');
                    label.className = 'model-label';
                    label.textContent = `Generated by ${getDisplayName(finalModel)}`;
                    container.insertBefore(label, container.firstChild);

                } catch (err) {
                    content.innerHTML = 'ÈîôËØØ: ' + err.message;
                } finally {
                    isThinking = false;
                    sendBtn.disabled = false;
                    inputBox.disabled = false;
                    inputBox.focus();
                }
            }

            // ‰∫ã‰ª∂ÁªëÂÆö
            inputBox.addEventListener('input', () => {
                inputBox.style.height = 'auto';
                inputBox.style.height = Math.min(inputBox.scrollHeight, 132) + 'px';
            });
            inputBox.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !isThinking) {
                    e.preventDefault();
                    send();
                }
            });
            sendBtn.addEventListener('click', send);
            webToggle.addEventListener('click', () => {
                if (webToggle.disabled) return;
                webEnabled = !webEnabled;
                webToggle.classList.toggle('active', webEnabled);
            });
            newChat.addEventListener('click', () => {
                if (chatContainer.children.length > 1 && !confirm('Êñ∞ÂØπËØùÂ∞ÜÊ∏ÖÈô§ÂΩìÂâçËÆ∞ÂΩïÔºåÁ°ÆËÆ§Ôºü')) return;
                location.reload();
            });

            // ‰∏ãÊãâ‰∫§‰∫í
            selectSelected.addEventListener('click', (e) => {
                e.stopPropagation();
                selectItems.classList.toggle('active');
            });
            document.addEventListener('click', (e) => {
                if (!customSelect.contains(e.target)) selectItems.classList.remove('active');
            });
            selectItems.addEventListener('click', (e) => {
                let target = e.target.closest('.select-item');
                if (!target || target.classList.contains('select-group')) return; // ÂøΩÁï•ÂàÜÁªÑÊ†áÈ¢ò
                // ÂèñÊ∂àÂÖ∂‰ªñÈÄâ‰∏≠
                document.querySelectorAll('.select-item:not(.select-group)').forEach(el => el.classList.remove('selected'));
                target.classList.add('selected');
                selectSelected.textContent = target.textContent;

                let base = target.dataset.value;
                let legacy = target.dataset.legacy === 'true';
                webToggle.disabled = legacy;
                webToggle.style.opacity = legacy ? '0.5' : '1';
                if (legacy) webToggle.classList.remove('active');

                updateEnhanceVisibility(base);
                selectItems.classList.remove('active');
            });

            // ÂêØÂä®
            buildSelect();
            buildHeaderEnhance();  // ÂàõÂª∫Â§¥ÈÉ®ÊåâÈíÆ
            inputBox.focus();
        })();
    </script>
</body>
</html>
